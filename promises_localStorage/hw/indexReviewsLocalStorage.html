<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reviews</title>
    <style>
        .block {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        form {
            display: flex;
            flex-direction: column;
            margin: 10px auto;
            width: 70%;
            gap: 10px;
        }

        .item_review {
            border-bottom: 1px dashed grey;
        }

        .product_item {
            padding: 0 32px 20px;
        }

        .form_review {
            border-left: 1px solid grey;
            padding-left: 10px;
        }
    </style>
</head>

<body>
    <div class="block">
        <h3>Оставьте свой отзыв</h3>
        <form action="#">
            <select name="product">
                <option>Выберите продукт из списка</option>
            </select>
            <input type="text" placeholder="Введите название товара">
            <textarea name="review" cols="30" rows="5" placeholder="Введите свой отзыв"></textarea>
            <button class="send" type="submit">Отправить</button>
        </form>
        <div class="reviewForm">
        </div>
    </div>

    <script>
        const formRun = document.querySelector(".block");
        const reviewForm = document.querySelector(".reviewForm");
        const listProduct = document.querySelector("select");
        const textReview = document.querySelector("textarea");

        const inputProduct = document.querySelector("input");
        inputProduct.style.marginBottom = "-30px";
        inputProduct.style.visibility = "hidden";

        localStorage.setItem("Apple iPhone 13", "Отличный телефон! Батарея держится долго.&&&Камера супер, фото выглядят просто потрясающе.");
        localStorage.setItem("Samsung Galaxy Z Fold 3", "Интересный дизайн, но дорогой.");
        localStorage.setItem("Sony PlayStation 5", "Люблю играть на PS5, графика на высоте.");

        for (let i in localStorage) {
            if (localStorage.hasOwnProperty(i)) {
                const option = document.createElement("option"); // создаем элемент списка для выбора продукта
                option.textContent = i;
                listProduct.append(option);
            }
        }
        const option = document.createElement("option"); // добавляем в список для для выбора продукта вариант "Другой"
        option.textContent = "Другой";
        listProduct.append(option);

        listProduct.addEventListener("change", (event) => {  // добавляем поле для ввода, если нужного товара не оказалось в списке
            if (event.target.value === 'Другой') {
                inputProduct.style.visibility = "visible";
                inputProduct.style.marginBottom = "0px";
                reviewForm.innerHTML = "";
            } else {
                inputProduct.style.marginBottom = "-30px";
                inputProduct.style.visibility = "hidden";

                reviewForm.innerHTML = "";
                const productItem = document.createElement("div"); // блок отзывов для одного продукта
                productItem.className = "product_item";

                const headingProduct = document.createElement("h3");  // название продукта
                headingProduct.textContent = event.target.value;
                headingProduct.className = "heading_product";
                productItem.append(headingProduct);

                const formReviewProduct = document.createElement("div"); // поле с отзывами этого продукта
                formReviewProduct.className = "form_review"

                const reviewListLS = localStorage.getItem(event.target.value).split("&&&"); // выгружаем список отзывов по выбранному товару
                reviewListLS.forEach((item, index) => {
                    const itemReviewProduct = document.createElement("p"); // выводим все отзывы на страницу
                    itemReviewProduct.textContent = item;
                    itemReviewProduct.className = "item_review";
                    formReviewProduct.append(itemReviewProduct);
                })
                productItem.append(formReviewProduct);
                reviewForm.append(productItem);
            }
        })

        formRun.addEventListener('submit', (event) => {
            event.preventDefault();
            try {
                if (listProduct.value === "Другой") {
                    const newProduct = inputProduct.value.trim();
                    if (newProduct !== "") {
                        localStorage.setItem(newProduct, textReview.value); // добавляем продукт и отзыв к нему в Local Storage

                        const option = document.createElement("option"); // создаем элемент списка для выбора продукта
                        option.textContent = newProduct;
                        listProduct.append(option);

                        listProduct.value = newProduct;
                        inputProduct.style.visibility = "hidden";
                        inputProduct.style.marginBottom = "-30px";

                        const productItem = document.createElement("div"); // блок отзывов для одного продукта
                        productItem.className = "product_item";

                        const headingProduct = document.createElement("h3");  // название продукта
                        headingProduct.textContent = newProduct;
                        headingProduct.className = "heading_product";

                        const formReviewProduct = document.createElement("div"); // поле с отзывами этого продукта
                        formReviewProduct.className = "form_review"

                        const itemReviewProduct = document.createElement("p"); // заполняем поле с отзывами
                        itemReviewProduct.textContent = textReview.value.trim() !== ""
                            ? textReview.value.trim()
                            : "Будьте первым, оставьте свой отзыв";
                        itemReviewProduct.className = "item_review";
                        formReviewProduct.append(itemReviewProduct);

                        productItem.append(headingProduct);
                        productItem.append(formReviewProduct);
                        reviewForm.append(productItem);
                    } else {
                        throw new Error("Укажите название продукта!")
                    }
                } else {
                    if (textReview.value !== "") {
                        const selectedProductForm = document.querySelector(`.form_review`); // ищем блок с отзывами выбранного продукта
                        if (localStorage.getItem(listProduct.value).length === 0) {
                            selectedProductForm.innerHTML = "";
                        }
                        const itemReviewProduct = document.createElement("p"); // создаем html-элемент с новым отзывом
                        itemReviewProduct.textContent = textReview.value;
                        itemReviewProduct.className = "item_review";
                        selectedProductForm.append(itemReviewProduct);

                        const updatedReviewList = localStorage.getItem(listProduct.value) + "&&&" + textReview.value;
                        localStorage.setItem(listProduct.value, updatedReviewList);
                    } else {
                        throw new Error("Напишите хотя бы пару слов о продукте")
                    }
                }
            } catch (error) {
                console.log(error);
            }
            inputProduct.value = ""
            textReview.value = "";
        })
    </script>
</body>

</html>