<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reviews</title>
    <link rel="stylesheet" href="styleReviewsLocalStorage.css">
</head>

<body>
    <div class="block">
        <h1 class="head_form">Оставьте свой отзыв</h1>
        <form action="#" class="form">
            <select name="product">
                <option>Выберите продукт из списка</option>
            </select>
            <input type="text" placeholder="Введите название товара">
            <textarea name="review" cols="30" rows="5" placeholder="Введите свой отзыв"></textarea>
            <button class="send" type="submit">Отправить</button>
        </form>
        <div class="reviewForm">
        </div>
    </div>

    <script>
        localStorage.clear()
        function showReview(event) {
            reviewForm.innerHTML = "";
            const productItem = document.createElement("div"); // блок отзывов для одного продукта
            productItem.className = "product_item";

            const headingProduct = document.createElement("h3");  // название продукта
            headingProduct.textContent = event;
            headingProduct.className = "heading_product";
            productItem.append(headingProduct);

            const formReviewProduct = document.createElement("div"); // поле с отзывами этого продукта
            formReviewProduct.className = "form_review"

            const reviewListLS = JSON.parse(localStorage.getItem(event));  // выгружаем список отзывов по выбранному товару
            reviewListLS.forEach((item, index) => {
                const fieldItemReviewProduct = document.createElement("div"); // создаем поле с отзывом и кнопкой удаления
                fieldItemReviewProduct.className = "field_item_product";

                const itemReviewProduct = document.createElement("p"); // сам отзыв
                itemReviewProduct.textContent = item.review;
                itemReviewProduct.className = "item_review";
                fieldItemReviewProduct.append(itemReviewProduct);

                btnRemoveReview = document.createElement("button");
                btnRemoveReview.className = "btn_remove";
                btnRemoveReview.textContent = "x";
                fieldItemReviewProduct.append(btnRemoveReview);

                btnRemoveReview.addEventListener("click", (event) => {
                    let isRemove = true;
                    let time = 5;
                    const deletedReview = event.target.parentNode; // удаляемая строка HTML
                    [...deletedReview.children].forEach(item => item.style.display = "none");
                    const returnReview = document.createElement("div"); // создаем кнопку для отмены удаления отзыва
                    returnReview.className = "returnForm";
                    const returnReviewText = document.createElement("p");
                    returnReviewText.className = "returnText";
                    returnReviewText.classList.add("item_review");
                    returnReviewText.textContent = "Вернуть отзыв";
                    const timer = document.createElement("span");
                    timer.style.marginLeft = "20px";
                    returnReview.append(returnReviewText);
                    returnReview.append(timer);
                    deletedReview.append(returnReview);

                    returnReviewText.addEventListener("click", () => {
                        isRemove = false;
                        time = 1;
                        returnReview.remove();
                        [...deletedReview.children].forEach(item => {
                            item.style.display = "block"
                        });
                    })

                    const deletedReviewLS = event.target.parentNode.parentNode.parentNode;
                    const keyDeletedReview = deletedReviewLS.querySelector(".heading_product").textContent; // определяем название продукта
                    const listReviewProductAll = JSON.parse(localStorage.getItem(keyDeletedReview));
                    const deletedReviewText = deletedReview.querySelector(".item_review").textContent;  //  текст удаляемого отзыва

                    listReviewProductAll.forEach((item, index) => { // список без удаляемого отзыва
                        if (item.review === deletedReviewText) {
                            listReviewProductAll.splice(index, 1);
                        }
                    })
                    let timerId = setInterval(() => {  // обратный отсчет до удаления из Local Storage
                        timer.textContent = time;
                        time -= 1
                    }, 1000);
                    setTimeout(() => {  // по истечении time данные об отзыве будут удалены из хранилища
                        clearInterval(timerId);
                        if (isRemove) {
                            localStorage.setItem(keyDeletedReview, JSON.stringify(listReviewProductAll));
                            deletedReview.remove();
                            if (!listReviewProductAll.length) {
                                const notReview = document.createElement("p");
                                notReview.textContent = "У этого товара пока нет отзывов. Будьте первым!";
                                notReview.className = "item_review";
                                formReviewProduct.append(notReview);
                            }
                        }
                    }, (time + 1) * 1000)
                })

                formReviewProduct.append(fieldItemReviewProduct);
            })
            productItem.append(formReviewProduct);
            reviewForm.append(productItem);
        }

        const formRun = document.querySelector(".block");
        const reviewForm = document.querySelector(".reviewForm");
        const listProduct = document.querySelector("select");
        const textReview = document.querySelector("textarea");

        const inputProduct = document.querySelector("input");
        inputProduct.style.marginBottom = "-30px";
        inputProduct.style.visibility = "hidden";

        localStorage.setItem("Apple iPhone 13", JSON.stringify([{ id: 1, review: "Отличный телефон! Батарея держится долго." }, { id: 2, review: "Good" }]));
        localStorage.setItem("Samsung Galaxy Z Fold 3", JSON.stringify([{ id: 1, review: "Интересный дизайн, но дорогой." }]));
        localStorage.setItem("Sony PlayStation 5", JSON.stringify([{ id: 1, review: "Люблю играть на PS5, графика на высоте." }]));

        for (let i in localStorage) {
            if (localStorage.hasOwnProperty(i)) {
                const option = document.createElement("option"); // создаем элемент списка для выбора продукта
                option.textContent = i;
                listProduct.append(option);
            }
        }
        const option = document.createElement("option"); // добавляем в список для для выбора продукта вариант "Другой"
        option.textContent = "Другой";
        listProduct.append(option);

        listProduct.addEventListener("change", (event) => {  // добавляем поле для ввода, если нужного товара не оказалось в списке
            if (event.target.value === 'Другой') {
                inputProduct.style.visibility = "visible";
                inputProduct.style.marginBottom = "0px";
                reviewForm.innerHTML = "";
            } else {
                inputProduct.style.marginBottom = "-30px";
                inputProduct.style.visibility = "hidden";
                showReview(event.target.value);
            }
        })

        formRun.addEventListener('submit', (event) => {
            event.preventDefault();
            try {
                if (listProduct.value === "Другой") {
                    const newProduct = inputProduct.value.trim();
                    if (newProduct !== "") {
                        const option = document.createElement("option"); // создаем элемент списка для выбора продукта
                        option.textContent = newProduct;
                        listProduct.append(option);

                        listProduct.value = newProduct;
                        inputProduct.style.visibility = "hidden";
                        inputProduct.style.marginBottom = "-30px";

                        if (textReview.value !== "") {
                            localStorage.setItem(newProduct, JSON.stringify([{ id: 1, review: textReview.value }])); // добавляем продукт и отзыв к нему в Local Storage
                            showReview(newProduct);
                        } else {
                            throw new Error("Напишите хотя бы пару слов о продукте");
                        }
                    } else {
                        throw new Error("Укажите название продукта!")
                    }
                } else {
                    if (textReview.value !== "") {
                        const updatedReviewList = JSON.parse(localStorage.getItem(listProduct.value));
                        console.log(updatedReviewList)
                        if (updatedReviewList) {
                            updatedReviewList.push({ id: updatedReviewList.length + 1, review: textReview.value });
                            localStorage.setItem(listProduct.value, JSON.stringify(updatedReviewList)); // дополняем список отзывов в Local Storage новым
                            showReview(listProduct.value);
                        } else {
                            localStorage.setItem(listProduct.value, JSON.stringify([{ id: 1, review: textReview.value }]))
                        }
                    } else {
                        throw new Error("Напишите хотя бы пару слов о продукте")
                    }
                }
            } catch (error) {
                console.log(error);
            }
            inputProduct.value = ""
            textReview.value = "";
        })

        const btnRemove = document.querySelector(".btn_remove");

    </script>
</body>

</html>